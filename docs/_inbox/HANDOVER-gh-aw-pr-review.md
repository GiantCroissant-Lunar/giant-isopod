# Handover — gh-aw PR Review Comment Resolver

## What was done

PR #8 merged to main — added a GitHub Agentic Workflow that automatically triages and resolves PR review comments using Copilot as the AI engine.

### Background

An online Claude agent (via `gh copilot`) created the initial workflow on branch `claude/gh-aw-pr-review-BBvQ4` but couldn't compile it locally. The workflow also had a schema error (`model` placed at the top level instead of only inside `safe-outputs/assign-to-agent`). This session completed the setup.

### Steps performed

1. **Initialized gh-aw** (`gh aw init --no-mcp`) — created the dispatcher agent (`.github/agents/agentic-workflows.agent.md`), actions lock (`.github/aw/actions-lock.json`), and `.gitattributes` (marks `.lock.yml` as generated).

2. **Fixed schema errors** in `.github/workflows/pr-review-resolver.md`:
   - Removed top-level `model: claude-sonnet-4-6` (invalid at that level)
   - Changed `engine: claude` to `engine: copilot` (no Anthropic API key needed)
   - Changed `assign-to-agent` model from `"claude-sonnet-4-6"` to `"auto"`

3. **Compiled the workflow** (`gh aw compile`) — generated `.github/workflows/pr-review-resolver.lock.yml` (62 KB GitHub Actions YAML), 0 errors, 0 warnings.

4. **Updated `.secrets.baseline`** — the `detect-secrets` pre-commit hook flagged action commit SHAs in `actions-lock.json` as high-entropy hex strings. Regenerated baseline to mark them as known false positives.

5. **Set repo secrets** via `gh aw secrets set`:
   - `COPILOT_GITHUB_TOKEN` — fine-grained PAT, scope: Account > Copilot Requests (Read)
   - `GH_AW_AGENT_TOKEN` — fine-grained PAT, scopes: Actions/Contents/Issues/Pull requests (Write)

6. **Merged PR #8**, deleted remote and local branch, cleaned up worktree.

### Files added/modified

| File | Description |
|------|-------------|
| `.gitattributes` | Marks `*.lock.yml` as generated (linguist) |
| `.github/agents/agentic-workflows.agent.md` | gh-aw dispatcher agent (routes to create/update/debug prompts) |
| `.github/aw/actions-lock.json` | Pinned action SHAs (checkout, upload/download-artifact, github-script, setup-node, gh-aw/setup) |
| `.github/workflows/pr-review-resolver.md` | Workflow source (natural language + frontmatter config) |
| `.github/workflows/pr-review-resolver.lock.yml` | Compiled GitHub Actions YAML (generated by `gh aw compile`) |
| `.secrets.baseline` | Updated to include action SHA false positives |

## How the workflow works

### Trigger

Fires on `pull_request_review_comment` → `created`.

### Decision framework

The Copilot engine reads the review comment and surrounding code context, then chooses one of:

| Action | When |
|--------|------|
| **assign-to-agent** | Comment requests a concrete code change (bug fix, refactor, missing tests) |
| **reply + resolve** | Comment is a question, compliment, FYI, style preference handled by linter, or out-of-scope suggestion |
| **leave open** | Comment expresses a blocking concern — left for human discussion |

### Safe outputs (rate limits)

| Output | Max per run |
|--------|-------------|
| `reply-to-pull-request-review-comment` | 10 |
| `resolve-pull-request-review-thread` | 10 |
| `assign-to-agent` (Copilot) | 1 |
| `add-comment` | 1 (hides older comments) |

### Permissions

- `contents: read`
- `pull-requests: read`
- GitHub toolsets: `repos`, `pull_requests`, `context`

## Secrets reference

| Secret | Type | Required scopes | Purpose |
|--------|------|-----------------|---------|
| `COPILOT_GITHUB_TOKEN` | Fine-grained PAT (user-owned) | Account > Copilot Requests: Read | Authenticate Copilot CLI engine |
| `GH_AW_AGENT_TOKEN` | Fine-grained PAT (user or org) | Actions, Contents, Issues, Pull requests: Write | Allow assigned Copilot agent to push commits |
| `GITHUB_TOKEN` | Auto-provided | N/A | Fallback for most GitHub API calls |

Both PATs are fine-grained (not classic). `COPILOT_GITHUB_TOKEN` must target public repositories even for private repos (required for the "Copilot Requests" permission to appear).

## Maintenance

### Recompiling after edits

If you edit `pr-review-resolver.md`, regenerate the lock file:

```bash
gh aw compile
gh aw compile --validate  # verify 0 errors
```

The `.lock.yml` is a generated file — never edit it directly.

### Updating pinned actions

```bash
gh aw compile  # automatically updates actions-lock.json
```

### Rotating secrets

```bash
gh aw secrets set COPILOT_GITHUB_TOKEN --value "<new-pat>"
gh aw secrets set GH_AW_AGENT_TOKEN --value "<new-pat>"
```

## Known limitations

- The workflow cannot handle review comments on draft PRs differently (no draft filter in trigger)
- `assign-to-agent` is capped at 1 per workflow run — if multiple comments need code changes, only the first triggers Copilot
- The workflow prompt is tuned for this project's stack (Godot 4.6 + C#/.NET); fork repos may need prompt adjustments
